name: vCnafacul
on:
  pull_request: 
    branches: ["main"]
    types:
      - closed

jobs:
  CI:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - uses: actions/checkout@v3
      - name: Iniciando CI
        run: echo "Iniciando CI"
      - uses: actions/setup-node@v1
        with:
          node-version: 16.x
      - name: Install depends
        run: yarn
      - name: Testes
        run: yarn test
        env:
          PORT: ${{ vars.PORT }}
          HOST: ${{ vars.HOST }}
          NODE_ENV: ${{ vars.NODE_ENV }}
          APP_KEY: ${{ secrets.APP_KEY }}
          DB_CONNECTION: pg
          PG_HOST: localhost
          PG_PORT: ${{ vars.PG_PORT }}
          PG_USER: postgres
          PG_PASSWORD: password
          PG_DB_NAME: testdb
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
      - name: Build app vCnafacul
        run: npm run build
      - name: Build Image
        run: docker build -t vcnafacul -f docker/node.dockerfile .
      - name: docker tags
        run: docker tag vcnafacul vcnafacul/api:stable
      - name: docker login
        run: docker login -u ${{ secrets.DOCKER_USER }} -p ${{ secrets.DOCKER_PASSWORD }}
      - name: Image Push
        run: docker push vcnafacul/api:stable
